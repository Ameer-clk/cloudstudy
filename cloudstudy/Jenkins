pipeline {
    agent any
    
    environment {
        AWS_REGION = 'us-east-1'
        AWS_ECS_CLUSTER = 'cloudstudycluster'
        AWS_ECR_REPO = 'cloudstudyrepo'
        DOCKER_IMAGE_TAG = 'latest'
        SONARQUBE_URL = 'http://44.201.116.255'
        SONARQUBE_TOKEN = credentials('3a11f651a43519c6ef486a9f3d6f850659b68667')
    }
    
    stages {
        stage('SCM') {
            steps {
                checkout scm
            }
        }
        
        stage('SonarQube Analysis') {
            steps {
                script {
                    def scannerHome = tool 'SonarScanner'
                    withSonarQubeEnv('SonarQube') {
                        sh "${scannerHome}/bin/sonar-scanner"
                    }
                }
            }
        }
        
        stage('Build and Push Docker Image') {
            steps {
                script {
                    def dockerImage = docker.build("${AWS_ECR_REPO}:${DOCKER_IMAGE_TAG}")
                    docker.withRegistry('https://098386855668.dkr.ecr.us-east-1.amazonaws.com', 'ecr:us-east-1:ecrcredentail') {
                        dockerImage.push()
                    }
                }
            }
        }
        
        stage('Deploy to ECS') {
            steps {
                script {
                    withAWS(region: "${AWS_REGION}", credentials: 'your-aws-ecrcredentail') {
                        ecsUpdateService(cluster: "${AWS_ECS_CLUSTER}", service: 'cloudstudycluster') {
                            taskDefinition = "${AWS_ECR_REPO}:${DOCKER_IMAGE_TAG}"
                        }
                    }
                }
            }
        }
    }
}
